# 自律型AIシステム 取扱説明書

---

## 1. はじめに

このドキュメントは、「完全自律型AIシステム on Raspberry Pi 4B」の取扱説明書です。システムの起動から日常的な運用、トラブルシューティングまで、AIと共存するための方法を解説します。

このシステムは、あなた専用のパーソナルAIアシスタントとして、24時間365日、自律的にタスクを実行し、学習を続けます。

## 2. システムの起動・停止

システムはRaspberry Piの起動時に自動で開始されますが、手動で操作することも可能です。

### 起動

システムを開始または再起動するには、以下のコマンドを実行します。

```bash
sudo systemctl start autonomous-ai.service
```

### 停止

システムを安全に停止するには、以下のコマンドを実行します。

```bash
sudo systemctl stop autonomous-ai.service
```

### 再起動

```bash
sudo systemctl restart autonomous-ai.service
```

## 3. システムの状態を確認する

AIが現在何をしているのか、正常に動作しているかを確認する方法です。

### サービス状態の確認

```bash
sudo systemctl status autonomous-ai.service
```

緑色の `active (running)` が表示されていれば、システムは正常に稼働しています。

### AIの思考をリアルタイムで見る

AIの思考プロセス、実行コマンド、判断内容などをリアルタイムで確認できます。

```bash
journalctl -u autonomous-ai.service -f
```

`Ctrl + C` で監視を終了します。

## 4. AIとの対話方法 (LINE)

LINEを通じて、AIに新しい目標を与えたり、特定のタスクを指示したりできます。

1.  セットアップ時に設定したLINE公式アカウントを友達追加します。
2.  トーク画面から、AIに実行させたい内容を日本語で送信します。（例: 「最近のAI関連のニュースを調べてまとめて」）
3.  AIが指示を受け取ると、「📝 指示を受け付けました」と返信があります。
4.  その後、AIはあなたの指示を新しい目標として設定し、自律的にタスクを開始します。進捗はログで確認できます。

## 5. 通知を理解する

システムは、DiscordとLINEに様々な通知を送信します。主な通知は以下の通りです。

| 通知の種類 | アイコン | 内容 |
| :--- | :--- | :--- |
| **システム起動** | 🚀 | システムが正常に起動したことを知らせます。 |
| **システム停止** | ⏹️ | システムが停止したことを知らせます。 |
| **実行ログ** | 📊 | 定期的にAIの活動状況を報告します。 |
| **コストアラート** | ⚠️🚨🛑 | API使用料が設定した閾値に達したことを警告します。レベルに応じてアイコンが変わります。 |
| **課金確認** | 💰 | コストが発生する可能性のある処理の前に、実行の許可を求めます。 |
| **エラー発生** | ⚠️ | システム内でエラーが発生したことを知らせます。 |

## 6. コスト管理

本システムは、想定外の高額請求を防ぐために厳格な多層防御システムを備えています。

### コスト監視の仕組み

- **リアルタイム監視**: OpenAI APIの使用量を常に監視します。
- **2段階の閾値**: 「通常日」と「特別日」で異なる上限金額が設定されています。
- **自動停止**: 上限に達すると、AIは自動的にすべての活動を停止し、緊急通知を送信します。

### 課金リミット

| 日の種類 | 条件 | 注意通知 (LINE/Discord) | 警告通知 (LINE/Discord) | AI自動停止 + 緊急通知 |
| :--- | :--- | :--- | :--- | :--- |
| **通常日** | 下記以外の日 | 200円 | - | 300円 |
| **特別日** | 0, 6, 12, 18, 24, 30... 日目 | 500円 | 900円 | 1000円 |

**※ 初回起動日（0日目）は特別日として扱われます。**

### 課金前LINE確認

AIが「コストが発生する可能性がある」と判断した処理（例: 大量のデータ分析、複雑なAPI連携など）を実行する前に、あなたのLINEに確認メッセージが届きます。

- **「✅ 許可」** をタップすると、処理が実行されます。
- **「❌ 拒否」** をタップすると、処理はキャンセルされます。
- **10分以内に応答がない場合**、安全のため処理は自動的にキャンセルされます。

## 7. ストレージ管理 (NAS)

### 階層型ストレージ

- **SSD (メイン)**: OSとプログラムが格納され、高速に動作します。
- **HDD (アーカイブ)**: 長期間アクセスされていないファイル（ログ、古い記憶など）が自動的にこちらに移動され、SSDの空き容量を確保します。

### NASへのアクセス

アーカイブされたファイルには、同じネットワーク内のPCからアクセスできます。

- **Windows**: エクスプローラーのアドレスバーに `\\<Raspberry PiのIPアドレス>\nas` と入力します。
- **Mac**: Finderの「サーバへ接続」で `smb://<Raspberry PiのIPアドレス>/nas` と入力します。

ログインを求められたら、Raspberry Piのユーザー名（`pi`）と、インストール時に設定したSamba用のパスワードを入力してください。

## 8. トラブルシューティング

### Q. システムが動いていないようです

**A.** まず、`sudo systemctl status autonomous-ai.service` で状態を確認してください。`inactive` や `failed` になっている場合は、`journalctl -u autonomous-ai.service -n 50` で直近のログを確認し、エラーメッセージを調べてください。環境変数の設定ミスや、依存パッケージのインストール失敗が主な原因です。

### Q. LINEやDiscordに通知が来ません

**A.** `.env` ファイルに設定したAPIキーやWebhook URLが正しいか再確認してください。特に、DiscordのWebhook URLは有効期限がある場合があるので注意が必要です。

### Q. コストが急に増えました

**A.** `journalctl` ログで、AIがどのようなタスクを実行していたか確認してください。特定の調査や分析に多くのAPIコールを消費した可能性があります。もし意図しない動作であれば、LINEから新しい指示を与えて目標を修正するか、一度システムを停止してください。

## 9. システムのメンテナンス

システムは自律的にメンテナンス（一時ファイルの削除、ストレージの整理など）を行いますが、手動で更新することも重要です。

```bash
# パッケージリストを更新
sudo apt-get update

# システム全体をアップグレード
sudo apt-get upgrade -y

# Pythonパッケージを更新
cd /home/pi/autonomous_ai
source .venv/bin/activate
pip3 install --upgrade -r requirements.txt

# 最後にシステムを再起動
sudo systemctl restart autonomous-ai.service
```

---

**AIと共に、新しい可能性を探求してください！**


## 10. 自己進化機能（自己コード修正）

このシステムには、**AIが自身のソースコードを読み込み、バグを修正したり、新しい機能を追加したりする能力**が備わっています。これにより、真の自己進化型システムとして動作します。

### 仕組み

AIは、自身の思考プロセスの中で「自分のコードを改善すべきだ」と判断した場合、`self_improve` フィールドを使用して自己改善を実行できます。

具体的には、以下のような流れで動作します。

1.  **コード分析**: AIが指定されたPythonファイル（または全ファイル）を読み込み、GPT-4を使って分析します。
2.  **問題発見**: バグ、非効率なコード、セキュリティリスクなどを自動で発見します。
3.  **修正提案**: 発見した問題に対する修正案を生成します。
4.  **リスク評価**: 修正のリスクレベル（low/medium/high）を自動で判定します。
5.  **バックアップ作成**: 修正を適用する前に、必ず元のファイルのバックアップを作成します。
6.  **修正適用**: リスクが低く、安全と判断された場合のみ、修正を自動で適用します。

### 自己改善の実行方法

#### 方法1: AIの自律判断による実行

AIは、自身の動作中にエラーが頻発したり、パフォーマンスが低下したりした場合、自律的に「自分のコードを見直すべきだ」と判断し、自己改善を実行することがあります。

この場合、ログに以下のようなメッセージが表示されます。

```
[WARNING] 自己改善機能を実行します
```

#### 方法2: LINEからの明示的な指示

LINEを通じて、AIに明示的に自己改善を指示することもできます。

例:
- 「自分のコードをチェックして、バグがあれば修正して」
- 「memory.pyのパフォーマンスを改善して」
- 「すべてのコードを見直して、セキュリティリスクを探して」

### 安全性について

自己コード修正は非常に強力な機能ですが、同時にリスクも伴います。そのため、以下の安全機構が組み込まれています。

| 安全機構 | 説明 |
| :--- | :--- |
| **バックアップ自動作成** | 修正前に必ず元のファイルを `/home/pi/autonomous_ai/backups/` にバックアップします。 |
| **リスク評価** | GPT-4が修正のリスクレベルを評価し、高リスクの修正は自動適用されません。 |
| **分析のみモード** | デフォルトでは、分析と修正提案のみを行い、実際の適用は行いません。 |
| **修正履歴の記録** | すべての修正は `/home/pi/autonomous_ai/logs/self_modifications.jsonl` に記録されます。 |

### ロールバック方法

もし自己改善によってシステムが不安定になった場合、バックアップから簡単にロールバックできます。

```bash
# バックアップ一覧を確認
ls -lh /home/pi/autonomous_ai/backups/

# 特定のファイルをロールバック（例: agent_core.py）
cp /home/pi/autonomous_ai/backups/agent_core_20260219_123456.py /home/pi/autonomous_ai/src/agent_core.py

# システムを再起動
sudo systemctl restart autonomous-ai.service
```

### 修正履歴の確認

AIが過去にどのような修正を行ったかは、修正履歴ファイルで確認できます。

```bash
cat /home/pi/autonomous_ai/logs/self_modifications.jsonl
```

各行が1つの修正セッションを表し、JSON形式で記録されています。

