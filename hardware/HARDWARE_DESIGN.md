# OLED・ファン制御システム設計書

---

## 1. 概要

Raspberry Pi 4B用Mini Towerクーラーに付属するOLEDディスプレイとPWMファンを制御し、システム状態とAI状態をリアルタイム表示するシステムを設計します。

---

## 2. ハードウェア仕様

### 2.1 OLEDディスプレイ

一般的なRaspberry Pi用Mini TowerクーラーのOLEDは以下の仕様です。

| 項目 | 仕様 |
| :--- | :--- |
| **ディスプレイ** | SSD1306 128x64ピクセル OLED |
| **インターフェース** | I2C |
| **I2Cアドレス** | 0x3C（標準） |
| **行数** | 4行（8x8フォント使用時） |
| **文字数/行** | 約21文字（6x8フォント使用時） |

### 2.2 PWMファン

| 項目 | 仕様 |
| :--- | :--- |
| **制御方式** | PWM（Pulse Width Modulation） |
| **GPIO端子** | GPIO 18（PWM0） |
| **周波数** | 25kHz（標準） |
| **デューティサイクル** | 0%（停止）〜100%（最大） |

---

## 3. OLED表示仕様

### 3.1 表示レイアウト

```
┌──────────────────────┐
│ CPU:55°C  Load:45%   │  ← 1行目：CPU温度 + CPU使用率
│ Mem:60%  SSD:75%     │  ← 2行目：メモリ使用率 + SSD使用率
│ Fan:2500RPM          │  ← 3行目：ファン状態
│ AI:Acting            │  ← 4行目：AI状態
└──────────────────────┘
```

### 3.2 AI状態表示

| 状態 | 表示 | 説明 |
| :--- | :--- | :--- |
| **Idle** | `AI:Idle` | アイドル状態 |
| **Planning** | `AI:Planning` | タスク計画中 |
| **Acting** | `AI:Acting` | コマンド実行中 |
| **Moving Files** | `AI:Moving Files` | ファイル移動中 |
| **Error** | `AI:Error` | エラー発生 |
| **Waiting Approval** | `AI:Wait Approval` | 課金承認待ち |

---

## 4. ファン制御仕様

### 4.1 温度連動制御

| CPU温度 | ファン速度 | PWMデューティサイクル | 説明 |
| :--- | :--- | :--- | :--- |
| **〜50°C** | 停止/低速 | 0%〜30% | 静音優先 |
| **50〜60°C** | 中速 | 50% | バランス |
| **60〜70°C** | 高速 | 75% | 冷却優先 |
| **70°C〜** | 最大 | 100% | 緊急冷却 + 警告通知 |

### 4.2 警告通知

CPU温度が70°C以上になった場合、以下の通知を送信します。

- **Discord**: 緊急通知
- **LINE**: 緊急通知
- **ログ**: ERROR レベルで記録

---

## 5. AI状態監視

### 5.1 状態ファイル

AIエージェントは、以下のファイルに状態を出力します。

**ファイルパス**: `/var/run/ai_state.json`

**フォーマット**:
```json
{
  "state": "Acting",
  "task": "NAS file migration",
  "timestamp": "2026-02-19 12:34:56"
}
```

### 5.2 状態の種類

- `Idle`: アイドル状態
- `Planning`: タスク計画中
- `Acting`: コマンド実行中
- `Moving Files`: ファイル移動中
- `Error`: エラー発生
- `Waiting Approval`: 課金承認待ち

---

## 6. システムアーキテクチャ

```
┌─────────────────────────────────────────┐
│         Raspberry Pi 4B                 │
│                                         │
│  ┌────────────────┐  ┌───────────────┐ │
│  │ AIエージェント  │  │ システム監視  │ │
│  │ (agent_core.py)│  │ (psutil)      │ │
│  └────────┬───────┘  └───────┬───────┘ │
│           │                  │         │
│           │ 状態出力         │ 情報取得│
│           ↓                  ↓         │
│  ┌────────────────────────────────────┐ │
│  │   OLED・ファン制御モジュール       │ │
│  │   (oled_fan_controller.py)        │ │
│  ├────────────────────────────────────┤ │
│  │ • AI状態読み込み                   │ │
│  │ • システム情報取得                 │ │
│  │ • OLED表示更新                     │ │
│  │ • PWMファン制御                    │ │
│  │ • 温度監視・警告                   │ │
│  └─────────┬──────────────────┬───────┘ │
│            │                  │         │
│            ↓                  ↓         │
│  ┌─────────────────┐  ┌──────────────┐ │
│  │ OLED (I2C)      │  │ PWMファン     │ │
│  │ SSD1306         │  │ (GPIO 18)    │ │
│  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────┘
```

---

## 7. 必要なライブラリ

### 7.1 Python パッケージ

| パッケージ | 用途 |
| :--- | :--- |
| **Adafruit-SSD1306** | OLEDディスプレイ制御 |
| **Pillow (PIL)** | 画像・テキスト描画 |
| **RPi.GPIO** | GPIO制御 |
| **psutil** | システム情報取得 |
| **smbus2** | I2C通信 |

### 7.2 システムパッケージ

```bash
sudo apt-get install -y python3-dev python3-pip i2c-tools
```

---

## 8. GPIO・I2C設定

### 8.1 I2C有効化

```bash
sudo raspi-config
# Interface Options → I2C → Enable
```

または、`/boot/config.txt` に追記:

```
dtparam=i2c_arm=on
```

### 8.2 PWM設定

GPIO 18をPWM0として使用します。`/boot/config.txt` に追記:

```
dtoverlay=pwm,pin=18,func=2
```

---

## 9. 低負荷設計

### 9.1 更新頻度

- **OLED更新**: 2秒ごと
- **ファン制御**: 5秒ごと
- **AI状態チェック**: 1秒ごと

### 9.2 CPU使用率

目標: **1%以下**

---

## 10. セキュリティ

### 10.1 ファイルパーミッション

```bash
# AI状態ファイル
sudo touch /var/run/ai_state.json
sudo chmod 666 /var/run/ai_state.json
```

### 10.2 GPIO アクセス

ユーザーを `gpio` グループに追加:

```bash
sudo usermod -a -G gpio,i2c pi
```

---

**この設計に基づいて、実装を進めます。**
