# 完全自律型AIシステム アーキテクチャ設計書

## システム概要

Raspberry Pi 4B上で動作する完全自律型AIエージェントシステム。GPTが自律的に判断・実行し、長期記憶を保持しながら、外部サービス（Discord/LINE）と連携し、課金安全制御を備えた常時稼働型パーソナルAIサーバー。

## システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Raspberry Pi 4B (SSD Boot)               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────┐    │
│  │         AIコアエージェント (agent_core.py)        │    │
│  │  - 自律判断ループ                                  │    │
│  │  - タスク計画・実行・評価                          │    │
│  │  - JSON出力制御                                    │    │
│  └───────┬──────────────────────────────┬──────────┘    │
│          │                              │                │
│  ┌───────▼────────┐          ┌──────────▼──────────┐    │
│  │ メモリ管理      │          │ コマンド実行エンジン │    │
│  │ (memory.py)    │          │ (executor.py)       │    │
│  │ - 長期記憶保存  │          │ - bash実行          │    │
│  │ - 日本語要約    │          │ - 安全性チェック     │    │
│  │ - 検索機能      │          │ - エラーハンドリング │    │
│  └────────────────┘          └─────────────────────┘    │
│                                                             │
│  ┌───────────────────────────────────────────────────┐    │
│  │         課金安全制御 (billing_guard.py)           │    │
│  │  - コスト監視（通常日/特別日）                     │    │
│  │  - LINE事前確認                                    │    │
│  │  - 自動停止機能                                    │    │
│  └───────────────────────────────────────────────────┘    │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Discord通知   │  │ LINE Bot     │  │ ブラウザ操作  │    │
│  │ (discord.py) │  │ (line_bot.py)│  │ (browser.py) │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                             │
│  ┌───────────────────────────────────────────────────┐    │
│  │      ストレージ管理 (storage_manager.py)          │    │
│  │  - SSD/HDD階層化                                   │    │
│  │  - NAS共有                                         │    │
│  │  - 自動ファイル移動                                │    │
│  └───────────────────────────────────────────────────┘    │
│                                                             │
│  ┌───────────────────────────────────────────────────┐    │
│  │         systemd自動起動 (autonomous-ai.service)   │    │
│  │  - 30秒自動再起動                                  │    │
│  │  - ログ管理                                        │    │
│  └───────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

外部接続:
  - OpenAI API (GPT-4)
  - Discord Webhook
  - LINE Messaging API
  - インターネット（ブラウザ操作）
```

## コンポーネント詳細

### 1. AIコアエージェント (`agent_core.py`)
**役割**: システムの中核。自律的な思考・判断・実行ループを管理

**主要機能**:
- GPT-4を使用した自律判断
- JSON形式での出力制御
- タスク計画 → 実行 → 評価 → 改善サイクル
- 長期目標の管理

**入出力**:
- 入力: ユーザー目標、前回の実行結果、メモリデータ
- 出力: JSON（say, cmd, memory_write, diary_append, next_goal）

### 2. メモリ管理 (`memory.py`)
**役割**: 長期記憶の保存・検索・要約

**主要機能**:
- トピック別ファイル保存（`memory/topic_yyyymmdd_hhmmss.txt`）
- 日本語自動要約
- 日誌管理（`memory/diary.txt`）
- 再起動後の記憶復元

**ストレージ**:
- `/home/pi/autonomous_ai/memory/` ディレクトリ

### 3. コマンド実行エンジン (`executor.py`)
**役割**: AIが指示したbashコマンドを安全に実行

**主要機能**:
- シェルコマンド実行
- 危険コマンドのブロック（`rm -rf /`, `mkfs`, etc.）
- タイムアウト制御
- 標準出力/エラー出力のキャプチャ

**安全性**:
- ホワイトリスト/ブラックリスト方式
- サンドボックス実行（将来拡張）

### 4. 課金安全制御 (`billing_guard.py`)
**役割**: API課金の監視と自動停止

**主要機能**:
- OpenAI API使用量のトラッキング
- 通常日と特別日（0, 6, 12, 18, 24, 30日目）の閾値管理
  - 通常日: 200円（注意）、300円（停止）
  - 特別日: 500円（注意）、900円（警告）、1000円（停止）
- 課金発生前のLINE確認（10分タイムアウト）
- 1日最大実行回数制限
- コスト見積もり送信

**データ保存**:
- `/home/pi/autonomous_ai/billing/usage.json`

### 5. Discord通知 (`discord_notifier.py`)
**役割**: システム状態をDiscordに通知

**主要機能**:
- 起動/停止通知
- 実行ログ送信
- エラー通知
- メモリ要約（日本語）の定期送信

**設定**:
- Webhook URL（環境変数）

### 6. LINE Bot (`line_bot.py`)
**役割**: スマホからの指示受付と通知

**主要機能**:
- LINE Messaging API連携
- 課金確認メッセージの送受信
- ユーザー指示の受付
- Discord同等の通知送信

**設定**:
- Channel Access Token（環境変数）
- Channel Secret（環境変数）

### 7. ブラウザ操作 (`browser_controller.py`)
**役割**: Web自動操作

**主要機能**:
- Playwright使用
- 自動ログイン（Cookie保存）
- スクリーンショット保存
- データスクレイピング

**ブラウザ**:
- Chromium（ヘッドレスモード）

### 8. ストレージ管理 (`storage_manager.py`)
**役割**: SSD/HDD階層化とNAS共有

**主要機能**:
- 未使用ファイルの自動移動（SSD→HDD）
- Samba NAS共有設定
- ディスク使用量監視
- アクセス時間ベースの階層化

**ストレージ構成**:
- SSD: `/home/pi/autonomous_ai/` (高速アクセス)
- HDD: `/mnt/hdd/archive/` (長期保存)

### 9. systemd自動起動 (`autonomous-ai.service`)
**役割**: システムの常時稼働と自動再起動

**主要機能**:
- システム起動時の自動起動
- クラッシュ時の30秒後自動再起動
- ログローテーション

**設定**:
- `Restart=always`
- `RestartSec=30`

## データフロー

### 起動フロー
```
1. systemd起動
   ↓
2. agent_core.py開始
   ↓
3. メモリ読み込み（memory.py）
   ↓
4. Discord/LINE通知「起動完了」
   ↓
5. 自律ループ開始
```

### 自律実行ループ
```
1. GPT-4に現在状態 + メモリ + 目標を送信
   ↓
2. JSON応答受信
   {
     "say": "...",
     "cmd": ["..."],
     "memory_write": [...],
     "diary_append": "...",
     "next_goal": "..."
   }
   ↓
3. 課金チェック（billing_guard.py）
   ├─ 閾値超過 → LINE確認 → 許可/拒否
   └─ 問題なし → 続行
   ↓
4. コマンド実行（executor.py）
   ↓
5. 結果をメモリに保存（memory.py）
   ↓
6. Discord/LINE通知
   ↓
7. 次のループへ（待機時間: 30秒）
```

### 課金確認フロー
```
1. 課金発生可能性検出
   ↓
2. コスト見積もり計算
   ↓
3. LINE通知「確認: XXX円かかります。許可しますか？」
   ↓
4. ユーザー応答待機（最大10分）
   ├─ 「許可」→ 実行
   ├─ 「拒否」→ スキップ
   └─ タイムアウト → 自動キャンセル
```

## 技術スタック

### 言語・フレームワーク
- Python 3.9+
- OpenAI Python SDK
- Discord Webhook
- LINE Messaging API SDK
- Playwright
- Flask（LINE Webhook用）

### システム
- Raspberry Pi OS (64-bit)
- systemd
- Samba（NAS）
- bash

### ストレージ
- SSD（起動ディスク）
- HDD（長期保存）

## セキュリティ設計

### 1. コマンド実行の安全性
- 危険コマンドのブラックリスト
- ファイルシステム破壊防止
- ネットワーク攻撃防止

### 2. API キー管理
- 環境変数での管理
- `.env`ファイル（gitignore）
- 権限制限（600）

### 3. 課金制御
- 多層防御（見積もり→確認→実行）
- 自動停止機能
- 日次上限設定

### 4. ネットワークセキュリティ
- ファイアウォール設定
- NASアクセス制限
- HTTPS通信

## 拡張性

### 将来の拡張ポイント
1. **マルチエージェント**: 複数のAIエージェントの協調動作
2. **音声インターフェース**: 音声での指示・応答
3. **カメラ連携**: 画像認識・監視機能
4. **IoT統合**: スマートホーム機器の制御
5. **学習機能強化**: 強化学習による自己改善
6. **クラウド連携**: AWS/GCP/Azureとのハイブリッド構成

## パフォーマンス要件

- **起動時間**: 30秒以内
- **応答時間**: GPT API呼び出し含め60秒以内
- **メモリ使用量**: 1GB以内
- **CPU使用率**: 平均50%以下
- **ディスク使用量**: SSD 32GB、HDD 1TB

## 運用設計

### ログ管理
- システムログ: `/var/log/autonomous-ai/system.log`
- 実行ログ: `/home/pi/autonomous_ai/logs/execution.log`
- エラーログ: `/home/pi/autonomous_ai/logs/error.log`
- ローテーション: 7日間保持

### バックアップ
- メモリデータ: 毎日バックアップ（HDD）
- 設定ファイル: Git管理
- システムイメージ: 月次バックアップ

### 監視
- Discord/LINEへの定期ヘルスチェック（1時間毎）
- ディスク使用量監視
- CPU/メモリ使用量監視
- API使用量監視

## 初期設定要件

### 必須情報
1. OpenAI API Key
2. Discord Webhook URL
3. LINE Channel Access Token
4. LINE Channel Secret
5. LINE User ID（通知先）

### ハードウェア要件
- Raspberry Pi 4B (4GB RAM以上推奨)
- SSD 64GB以上（起動用）
- HDD 1TB以上（保存用、オプション）
- 安定した電源
- 常時インターネット接続

## 開発フェーズ

1. **Phase 1**: コアエージェント実装
2. **Phase 2**: 外部連携（Discord/LINE）
3. **Phase 3**: ブラウザ操作
4. **Phase 4**: ストレージ管理
5. **Phase 5**: 課金制御
6. **Phase 6**: systemd統合
7. **Phase 7**: テスト・デバッグ
8. **Phase 8**: ドキュメント整備
